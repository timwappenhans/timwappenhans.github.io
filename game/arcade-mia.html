<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ARCADE-MIA</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #0a0a0a;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    font-family: 'Press Start 2P', monospace;
    overflow: hidden;
    image-rendering: pixelated;
  }

  #game-wrapper {
    position: relative;
    width: 800px;
    max-width: 100vw;
  }

  #scanlines {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.08) 2px,
      rgba(0,0,0,0.08) 4px
    );
    pointer-events: none;
    z-index: 10;
  }

  #crt-glow {
    position: absolute;
    top: -20px; left: -20px; right: -20px; bottom: -20px;
    background: radial-gradient(ellipse at center, rgba(40,80,40,0.15) 0%, transparent 70%);
    pointer-events: none;
    z-index: 11;
  }

  canvas {
    display: block;
    width: 800px;
    height: 500px;
    max-width: 100vw;
    border: 3px solid #333;
    border-radius: 2px;
    box-shadow:
      0 0 20px rgba(0,255,100,0.1),
      inset 0 0 60px rgba(0,0,0,0.3);
  }

  #mobile-hint {
    display: none;
    color: #555;
    font-size: 8px;
    text-align: center;
    margin-top: 10px;
    letter-spacing: 1px;
  }

  @media (max-width: 820px) {
    canvas { width: 100vw; height: auto; }
    #mobile-hint { display: block; }
  }
</style>
</head>
<body>

<div id="game-wrapper">
  <canvas id="game" width="800" height="500"></canvas>
  <div id="scanlines"></div>
  <div id="crt-glow"></div>
  <div id="mobile-hint">TAP TO JUMP</div>
</div>

<script>
// ============================================================
//  ARCADE-MIA â€” The Academic Career Runner
//  An easter egg by Tim Wappenhans
// ============================================================

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const W = 800, H = 500;

// ---------- PALETTE (NES-muted) ----------
const PAL = {
  bg:        '#101410',
  ground:    '#3a4a3a',
  groundLt:  '#4a5a4a',
  sky:       '#141820',
  text:      '#7a8a7a',
  textDim:   '#4a5a4a',
  accent:    '#a89860',
  danger:    '#883333',
  white:     '#b8b8b0',
  dark:      '#0a0e0a',
  panel:     '#1a221a',
  panelBord: '#3a4a3a',
};

// ---------- GAME STATE ----------
let state = 'title'; // title | playing | levelup | gameover
let score = 0;
let hIndex = 0; // high score
let levelIndex = 0;
let levelTimer = 0;
let gameSpeed = 4;
let frameCount = 0;
let groundY = H - 70;
let shakeX = 0, shakeY = 0;
let flashAlpha = 0;
let levelUpTimer = 0;
let deathReason = '';

// ---------- LEVELS ----------
const LEVELS = [
  {
    name: 'PhD Student',
    color: '#2a3a2a',
    bgColor: '#101820',
    obstacles: ['papers', 'rejection', 'deadline', 'coffee'],
    duration: 600,
    speedMult: 1.0,
    collectible: 'citation',
    ground: 'seminar',
  },
  {
    name: 'Post-Doc',
    color: '#2a3040',
    bgColor: '#10101a',
    obstacles: ['contract', 'movingbox', 'randr', 'coffee'],
    duration: 700,
    speedMult: 1.15,
    collectible: 'publication',
    ground: 'office',
  },
  {
    name: 'Grant Recipient',
    color: '#3a3425',
    bgColor: '#18160e',
    obstacles: ['bureaucracy', 'ethics', 'budget', 'gdpr'],
    duration: 800,
    speedMult: 1.3,
    collectible: 'grant',
    ground: 'conference',
  },
  {
    name: 'Tenure Track',
    color: '#3a2222',
    bgColor: '#180e0e',
    obstacles: ['evaluation', 'committee', 'service', 'hindexwall'],
    duration: 900,
    speedMult: 1.45,
    collectible: 'citation',
    ground: 'faculty',
  },
  {
    name: 'TENURE',
    color: '#302838',
    bgColor: '#100e18',
    obstacles: ['restructuring', 'adminmeeting', 'apsrreject', 'committee'],
    duration: 1000,
    speedMult: 1.6,
    collectible: 'publication',
    ground: 'office',
    isFinal: true,
  },
];

// ---------- PLAYER ----------
const player = {
  x: 100,
  y: 0,
  w: 32,
  h: 44,
  vy: 0,
  grounded: true,
  frame: 0,
  frameTimer: 0,
  alive: true,
  coffeeBoost: 0,
};

// ---------- OBSTACLES & COLLECTIBLES ----------
let obstacles = [];
let collectibles = [];
let particles = [];
let bgElements = [];
let stars = [];
let finishLine = null;
let finishReached = false;
let celebrationTimer = 0;

// Init stars
for (let i = 0; i < 60; i++) {
  stars.push({ x: Math.random() * W, y: Math.random() * (groundY - 40), size: Math.random() * 2 + 0.5, twinkle: Math.random() * Math.PI * 2 });
}

// ---------- INPUT ----------
let keys = {};
document.addEventListener('keydown', e => {
  keys[e.code] = true;
  if ((e.code === 'Space' || e.code === 'ArrowUp') && state === 'title') startGame();
  if ((e.code === 'Space' || e.code === 'ArrowUp') && state === 'gameover') resetToTitle();
  if (e.code === 'Space' || e.code === 'ArrowUp') e.preventDefault();
});
document.addEventListener('keyup', e => { keys[e.code] = false; });
canvas.addEventListener('touchstart', e => {
  e.preventDefault();
  keys['Space'] = true;
  if (state === 'title') startGame();
  if (state === 'gameover') resetToTitle();
});
canvas.addEventListener('touchend', e => { keys['Space'] = false; });
canvas.addEventListener('click', () => {
  if (state === 'title') startGame();
  if (state === 'gameover') resetToTitle();
});

// ---------- PIXEL ART HELPERS ----------
function drawPixelRect(x, y, w, h, color) {
  ctx.fillStyle = color;
  ctx.fillRect(Math.floor(x), Math.floor(y), w, h);
}

function drawPixelChar(px, py, mirror) {
  const f = player.frame;
  const s = 2; // pixel scale

  // Shadow
  ctx.fillStyle = 'rgba(0,0,0,0.3)';
  ctx.fillRect(px - 2, groundY - 2, 36, 6);

  // Body
  drawPixelRect(px + 8, py, 16, 24, '#556677'); // shirt (muted slate)
  drawPixelRect(px + 8, py + 24, 16, 12, '#2e3640'); // pants

  // Head
  drawPixelRect(px + 6, py - 16, 20, 16, '#c0a070'); // face (warm muted)

  // Hair
  drawPixelRect(px + 4, py - 20, 24, 6, '#3a2818');
  drawPixelRect(px + 4, py - 16, 4, 4, '#3a2818');

  // Glasses
  drawPixelRect(px + 8, py - 12, 7, 5, '#222');
  drawPixelRect(px + 17, py - 12, 7, 5, '#222');
  drawPixelRect(px + 10, py - 11, 3, 3, '#7a9aaa');
  drawPixelRect(px + 19, py - 11, 3, 3, '#7a9aaa');
  drawPixelRect(px + 15, py - 11, 2, 2, '#222'); // bridge

  // Coffee (held in front hand)
  if (player.coffeeBoost > 0) {
    drawPixelRect(px + 26, py + 4, 8, 12, '#6a4020');
    drawPixelRect(px + 27, py + 1, 6, 3, '#c8c0b0');
    // Steam
    if (frameCount % 20 < 10) {
      drawPixelRect(px + 28, py - 3, 2, 3, 'rgba(255,255,255,0.5)');
      drawPixelRect(px + 31, py - 5, 2, 3, 'rgba(255,255,255,0.3)');
    }
  }

  // Arms
  if (player.grounded) {
    const armSwing = f % 2 === 0 ? 0 : 3;
    drawPixelRect(px + 4, py + 2 + armSwing, 4, 14, '#c0a070');
    drawPixelRect(px + 24, py + 2 - armSwing, 4, 14, '#c0a070');
  } else {
    // Arms up when jumping
    drawPixelRect(px + 4, py - 6, 4, 12, '#c0a070');
    drawPixelRect(px + 24, py - 6, 4, 12, '#c0a070');
  }

  // Legs (animated)
  if (player.grounded) {
    if (f % 4 < 2) {
      drawPixelRect(px + 8, py + 36, 6, 8, '#222');
      drawPixelRect(px + 18, py + 32, 6, 12, '#222');
    } else {
      drawPixelRect(px + 8, py + 32, 6, 12, '#222');
      drawPixelRect(px + 18, py + 36, 6, 8, '#222');
    }
  } else {
    // Tucked legs when jumping
    drawPixelRect(px + 8, py + 32, 6, 6, '#222');
    drawPixelRect(px + 18, py + 32, 6, 6, '#222');
  }
}

// ---------- OBSTACLE DRAWING ----------
function drawObstacle(obs) {
  const x = Math.floor(obs.x);
  const y = Math.floor(obs.y);

  ctx.save();
  switch (obs.type) {
    case 'papers':
      for (let i = 0; i < 3; i++) {
        drawPixelRect(x + i * 2, y + i * 6, 28, 20, '#c8c8c0');
        drawPixelRect(x + i * 2 + 3, y + i * 6 + 4, 18, 2, '#7a7a70');
        drawPixelRect(x + i * 2 + 3, y + i * 6 + 8, 14, 2, '#7a7a70');
        drawPixelRect(x + i * 2 + 3, y + i * 6 + 12, 20, 2, '#7a7a70');
      }
      break;

    case 'rejection':
      drawPixelRect(x, y + 4, 36, 26, '#884444');
      drawPixelRect(x + 2, y + 6, 32, 22, '#aa6666');
      ctx.fillStyle = '#995555';
      ctx.beginPath();
      ctx.moveTo(x, y + 4);
      ctx.lineTo(x + 18, y + 18);
      ctx.lineTo(x + 36, y + 4);
      ctx.fill();
      drawPixelRect(x + 12, y + 14, 12, 3, '#c8c0b0');
      drawPixelRect(x + 16, y + 10, 3, 12, '#c8c0b0');
      break;

    case 'deadline':
      drawPixelRect(x + 4, y, 28, 28, '#a89860');
      drawPixelRect(x + 6, y + 2, 24, 24, '#c8c8c0');
      drawPixelRect(x + 16, y + 6, 3, 12, '#222');
      drawPixelRect(x + 16, y + 10, 10, 3, '#884444');
      if (frameCount % 30 < 20) {
        drawPixelRect(x + 15, y - 14, 5, 8, '#884444');
        drawPixelRect(x + 15, y - 4, 5, 3, '#884444');
      }
      break;

    case 'coffee':
      drawPixelRect(x + 4, y + 6, 20, 24, '#6a4020');
      drawPixelRect(x + 6, y + 8, 16, 20, '#8a6040');
      drawPixelRect(x + 24, y + 12, 6, 12, '#6a4020');
      if (frameCount % 16 < 8) {
        drawPixelRect(x + 8, y - 2, 3, 6, 'rgba(200,200,190,0.5)');
        drawPixelRect(x + 14, y - 4, 3, 6, 'rgba(200,200,190,0.3)');
      }
      break;

    case 'contract':
      drawPixelRect(x, y, 40, 8, '#6a5a3a');
      drawPixelRect(x, y + 8, 40, 22, '#8a7a5a');
      drawPixelRect(x + 10, y + 8, 2, 14, '#5a4a30');
      drawPixelRect(x + 25, y + 6, 2, 18, '#5a4a30');
      ctx.fillStyle = '#884444';
      ctx.font = '6px "Press Start 2P"';
      ctx.fillText('TEMP', x + 4, y + 22);
      break;

    case 'movingbox':
      drawPixelRect(x, y, 36, 30, '#8a7050');
      drawPixelRect(x + 2, y + 2, 32, 26, '#9a8060');
      drawPixelRect(x + 6, y + 12, 24, 3, '#7a6040');
      drawPixelRect(x + 14, y, 8, 30, 'rgba(140,120,80,0.4)');
      break;

    case 'randr':
      drawPixelRect(x, y + 2, 34, 28, '#b8b0a0');
      drawPixelRect(x + 2, y + 4, 30, 24, '#c8c0b0');
      ctx.fillStyle = '#884444';
      ctx.font = '7px "Press Start 2P"';
      ctx.fillText('R&R', x + 4, y + 18);
      drawPixelRect(x + 20, y + 18, 12, 10, 'rgba(136,68,68,0.3)');
      break;

    case 'bureaucracy':
      for (let i = 0; i < 4; i++) {
        drawPixelRect(x + i, y + i * 5, 32, 24, i % 2 === 0 ? '#b0b0a8' : '#c0c0b8');
      }
      ctx.fillStyle = '#884444';
      ctx.font = '5px "Press Start 2P"';
      ctx.fillText('FORM', x + 5, y + 14);
      ctx.fillText('27B/6', x + 3, y + 22);
      break;

    case 'ethics':
      drawPixelRect(x + 2, y, 30, 30, '#3a4a60');
      drawPixelRect(x + 4, y + 2, 26, 26, '#4a5a70');
      ctx.fillStyle = '#b8b8b0';
      ctx.font = '5px "Press Start 2P"';
      ctx.fillText('IRB', x + 8, y + 14);
      ctx.fillText('DENY', x + 5, y + 22);
      break;

    case 'budget':
      drawPixelRect(x, y + 2, 36, 28, '#4a6a4a');
      drawPixelRect(x + 2, y + 4, 32, 24, '#5a7a5a');
      for (let i = 0; i < 3; i++) {
        drawPixelRect(x + 2, y + 8 + i * 7, 32, 1, '#4a6a4a');
      }
      drawPixelRect(x + 14, y + 4, 1, 24, '#4a6a4a');
      ctx.fillStyle = '#884444';
      ctx.font = '6px "Press Start 2P"';
      ctx.fillText('-â‚¬â‚¬', x + 4, y + 24);
      break;

    case 'gdpr':
      drawPixelRect(x, y, 36, 34, '#3a4a60');
      drawPixelRect(x + 2, y + 2, 32, 30, '#4a5a70');
      ctx.fillStyle = '#a89860';
      ctx.font = '6px "Press Start 2P"';
      ctx.fillText('GDPR', x + 3, y + 14);
      drawPixelRect(x + 10, y + 18, 16, 12, '#a89860');
      drawPixelRect(x + 12, y + 20, 12, 8, '#4a5a70');
      break;

    case 'evaluation':
      drawPixelRect(x, y + 2, 32, 28, '#c8c8c0');
      drawPixelRect(x + 2, y + 4, 28, 24, '#c0b8a8');
      ctx.fillStyle = '#884444';
      ctx.font = '10px "Press Start 2P"';
      ctx.fillText('D-', x + 6, y + 22);
      break;

    case 'committee':
      drawPixelRect(x, y, 38, 30, '#3a3450');
      drawPixelRect(x + 2, y + 2, 34, 26, '#4a4460');
      ctx.fillStyle = '#b8b8b0';
      ctx.font = '5px "Press Start 2P"';
      ctx.fillText('MTG', x + 6, y + 14);
      ctx.fillText('15:00', x + 4, y + 22);
      break;

    case 'service':
      drawPixelRect(x, y, 34, 32, '#5a4020');
      drawPixelRect(x + 2, y + 2, 30, 28, '#7a6040');
      ctx.fillStyle = '#b8b8b0';
      ctx.font = '5px "Press Start 2P"';
      ctx.fillText('ADMIN', x + 2, y + 16);
      ctx.fillText('DUTY', x + 4, y + 24);
      break;

    case 'hindexwall':
      drawPixelRect(x, y, 34, 34, '#2a2a2a');
      drawPixelRect(x + 2, y + 2, 30, 30, '#1a1a1a');
      ctx.fillStyle = '#668844';
      ctx.font = '8px "Press Start 2P"';
      ctx.fillText('h=' + Math.floor(Math.random() * 5 + 2), x + 4, y + 20);
      break;

    case 'restructuring':
      drawPixelRect(x, y, 40, 34, '#5a2020');
      drawPixelRect(x + 2, y + 2, 36, 30, '#7a3030');
      ctx.fillStyle = '#a89860';
      ctx.font = '5px "Press Start 2P"';
      ctx.fillText('DEPT', x + 6, y + 14);
      ctx.fillText('CUT!', x + 6, y + 22);
      break;

    case 'adminmeeting':
      drawPixelRect(x, y, 44, 30, '#303040');
      drawPixelRect(x + 2, y + 2, 40, 26, '#404050');
      ctx.fillStyle = '#7a7a90';
      ctx.font = '5px "Press Start 2P"';
      ctx.fillText('3HR', x + 8, y + 14);
      ctx.fillText('MEET', x + 6, y + 22);
      if (frameCount % 40 < 25) {
        ctx.fillStyle = '#b8b8b0';
        ctx.font = '8px "Press Start 2P"';
        ctx.fillText('Z', x + 36, y - 4);
        ctx.font = '6px "Press Start 2P"';
        ctx.fillText('z', x + 40, y - 10);
      }
      break;

    case 'apsrreject':
      drawPixelRect(x, y - 4, 44, 38, '#5a1010');
      drawPixelRect(x + 2, y - 2, 40, 34, '#7a2020');
      ctx.fillStyle = '#b8b8b0';
      ctx.font = '6px "Press Start 2P"';
      ctx.fillText('APSR', x + 6, y + 10);
      ctx.fillText('DESK', x + 6, y + 20);
      ctx.fillText('REJ.', x + 8, y + 30);
      break;
  }
  ctx.restore();
}

function drawCollectible(col) {
  const x = Math.floor(col.x);
  const y = Math.floor(col.y);
  const bob = 0;

  ctx.save();
  switch (col.type) {
    case 'citation':
      drawPixelRect(x + 6, y + bob, 12, 12, '#a89860');
      drawPixelRect(x + 4, y + 2 + bob, 16, 8, '#a89860');
      drawPixelRect(x + 8, y - 2 + bob, 8, 16, '#a89860');
      ctx.fillStyle = '#6a5a30';
      ctx.font = '6px "Press Start 2P"';
      ctx.fillText('â˜…', x + 5, y + 10 + bob);
      break;

    case 'publication':
      drawPixelRect(x + 2, y + bob, 20, 16, '#4a5a70');
      drawPixelRect(x + 4, y + 2 + bob, 16, 12, '#5a6a80');
      ctx.fillStyle = '#b8b8b0';
      ctx.font = '4px "Press Start 2P"';
      ctx.fillText('PUB', x + 5, y + 10 + bob);
      break;

    case 'grant':
      drawPixelRect(x + 4, y + 4 + bob, 16, 14, '#5a7a5a');
      drawPixelRect(x + 6, y + 2 + bob, 12, 4, '#5a7a5a');
      ctx.fillStyle = '#a89860';
      ctx.font = '8px "Press Start 2P"';
      ctx.fillText('â‚¬', x + 7, y + 14 + bob);
      break;
  }
  ctx.restore();
}

// ---------- FINISH LINE ----------
function initFinishLine() {
  const level = LEVELS[levelIndex];
  const spd = gameSpeed * level.speedMult;
  // Place the finish line so it arrives after level.duration frames
  finishLine = {
    x: W + level.duration * spd,
    w: 16,
    reached: false,
  };
  finishReached = false;
  celebrationTimer = 0;
}

function drawFinishLine() {
  if (!finishLine || finishLine.x > W + 50) return;
  const x = Math.floor(finishLine.x);
  const level = LEVELS[levelIndex];
  const nextLevel = LEVELS[levelIndex + 1];
  const poleH = 220;
  const poleTop = groundY - poleH;
  const poleW = 12;

  // Checkered pole (wider squares)
  for (let i = 0; i < poleH; i += 12) {
    const even = (Math.floor(i / 12)) % 2 === 0;
    drawPixelRect(x, poleTop + i, poleW, 12, even ? '#b8b8b0' : '#2a2a2a');
    drawPixelRect(x + poleW, poleTop + i, poleW, 12, even ? '#2a2a2a' : '#b8b8b0');
  }

  // Banner / flag (much larger)
  const bannerW = 140;
  const bannerH = 56;
  const bannerY = poleTop - 8;

  // Banner shadow
  drawPixelRect(x + poleW * 2 + 4, bannerY + 4, bannerW, bannerH, '#1a1a1a');
  // Banner body
  drawPixelRect(x + poleW * 2, bannerY, bannerW, bannerH, '#2a2a2a');
  drawPixelRect(x + poleW * 2 + 3, bannerY + 3, bannerW - 6, bannerH - 6, '#3a3a3a');
  // Banner border accent
  drawPixelRect(x + poleW * 2, bannerY, bannerW, 3, '#a89860');
  drawPixelRect(x + poleW * 2, bannerY + bannerH - 3, bannerW, 3, '#a89860');

  // Banner text
  ctx.textAlign = 'center';
  const textCenterX = x + poleW * 2 + bannerW / 2;
  if (level.isFinal) {
    ctx.fillStyle = '#a89860';
    ctx.font = '14px "Press Start 2P"';
    ctx.fillText('TENURE!', textCenterX, bannerY + 24);
    ctx.fillStyle = '#7a8a7a';
    ctx.font = '8px "Press Start 2P"';
    ctx.fillText('FINISH LINE', textCenterX, bannerY + 42);
  } else if (nextLevel) {
    ctx.fillStyle = '#a89860';
    ctx.font = '10px "Press Start 2P"';
    ctx.fillText('NEXT:', textCenterX, bannerY + 20);
    ctx.fillStyle = '#b8b8b0';
    ctx.font = '9px "Press Start 2P"';
    ctx.fillText(nextLevel.name.toUpperCase(), textCenterX, bannerY + 40);
  }
  ctx.textAlign = 'left';

  // Checkered ground strip at the finish (wider)
  for (let row = 0; row < 5; row++) {
    for (let c = 0; c < 5; c++) {
      const even = (row + c) % 2 === 0;
      drawPixelRect(x - 16 + c * 14, groundY + row * 12, 14, 12, even ? '#b8b8b0' : '#2a2a2a');
    }
  }
}

// ---------- BACKGROUND ----------
function drawBackground() {
  const level = LEVELS[levelIndex] || LEVELS[0];

  // Sky gradient
  const grd = ctx.createLinearGradient(0, 0, 0, groundY);
  grd.addColorStop(0, level.bgColor);
  grd.addColorStop(1, level.color);
  ctx.fillStyle = grd;
  ctx.fillRect(0, 0, W, groundY);

  // Stars
  stars.forEach(s => {
    const twinkle = Math.sin(frameCount * 0.03 + s.twinkle);
    const alpha = 0.2 + twinkle * 0.2;
    ctx.fillStyle = `rgba(180,190,170,${alpha})`;
    ctx.fillRect(Math.floor(s.x), Math.floor(s.y), Math.ceil(s.size), Math.ceil(s.size));
  });

  // Background buildings/scenery
  drawScenery(level);

  // Ground
  ctx.fillStyle = level.color;
  ctx.fillRect(0, groundY, W, H - groundY);

  // Ground detail line
  ctx.fillStyle = '#fff';
  ctx.globalAlpha = 0.15;
  ctx.fillRect(0, groundY, W, 2);
  ctx.globalAlpha = 1;

  // Ground texture
  for (let i = 0; i < W; i += 16) {
    const offset = (frameCount * gameSpeed * 0.5 + i) % W;
    ctx.fillStyle = 'rgba(255,255,255,0.05)';
    ctx.fillRect((W - offset) % W, groundY + 8, 8, 2);
    ctx.fillRect((W - offset + 4) % W, groundY + 20, 6, 2);
  }
}

function drawScenery(level) {
  // Parallax buildings
  const scroll = frameCount * gameSpeed * 0.3;
  ctx.globalAlpha = 0.15;

  for (let i = 0; i < 8; i++) {
    const bx = ((i * 130 - scroll * 0.3) % (W + 200)) - 100;
    const bh = 60 + (i * 37 % 80);
    const bw = 40 + (i * 23 % 40);
    ctx.fillStyle = level.color;
    ctx.fillRect(bx, groundY - bh, bw, bh);

    // Windows
    ctx.fillStyle = '#8a7a50';
    for (let wy = groundY - bh + 8; wy < groundY - 8; wy += 14) {
      for (let wx = bx + 6; wx < bx + bw - 6; wx += 12) {
        if (Math.sin(wx * wy * 0.1 + frameCount * 0.01) > 0.2) {
          ctx.fillRect(wx, wy, 4, 6);
        }
      }
    }
  }
  ctx.globalAlpha = 1;
}

// ---------- PARTICLES ----------
function spawnParticles(x, y, color, count) {
  for (let i = 0; i < count; i++) {
    particles.push({
      x, y,
      vx: (Math.random() - 0.5) * 6,
      vy: (Math.random() - 1) * 5,
      life: 30 + Math.random() * 20,
      color,
      size: 2 + Math.random() * 3,
    });
  }
}

function updateParticles() {
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.15;
    p.life--;
    if (p.life <= 0) particles.splice(i, 1);
  }
}

function drawParticles() {
  particles.forEach(p => {
    ctx.globalAlpha = p.life / 50;
    drawPixelRect(p.x, p.y, p.size, p.size, p.color);
  });
  ctx.globalAlpha = 1;
}

// ---------- SPAWN LOGIC ----------
let spawnTimer = 0;
let collectibleTimer = 0;

function spawnObstacle() {
  const level = LEVELS[levelIndex];
  const types = level.obstacles.filter(t => t !== 'coffee');
  const type = types[Math.floor(Math.random() * types.length)];

  const obs = {
    type,
    x: W + 20,
    y: groundY - 34,
    w: type === 'apsrreject' || type === 'adminmeeting' ? 44 : type === 'restructuring' ? 40 : 36,
    h: type === 'apsrreject' ? 38 : 32,
    scored: false,
  };
  obstacles.push(obs);
}

function spawnCollectible() {
  const level = LEVELS[levelIndex];
  // 30% chance for coffee, rest is level collectible
  const isCoffee = Math.random() < 0.3;
  const type = isCoffee ? 'coffee' : level.collectible;

  collectibles.push({
    type: isCoffee ? 'coffee' : type,
    x: W + 20,
    y: groundY - 60 - Math.random() * 40,
    w: 24,
    h: 20,
    isCoffee,
  });
}

// ---------- GAME LOGIC ----------
function startGame() {
  state = 'playing';
  score = 0;
  levelIndex = 0;
  levelTimer = 0;
  gameSpeed = 4;
  player.y = groundY - player.h;
  player.vy = 0;
  player.grounded = true;
  player.alive = true;
  player.coffeeBoost = 0;
  obstacles = [];
  collectibles = [];
  particles = [];
  spawnTimer = 0;
  collectibleTimer = 0;
  initFinishLine();
}

function resetToTitle() {
  state = 'title';
}

function update() {
  frameCount++;

  if (state === 'playing') {
    const level = LEVELS[levelIndex];
    const spd = gameSpeed * level.speedMult * (player.coffeeBoost > 0 ? 1.2 : 1);

    // Level timer
    levelTimer++;
    score += Math.floor(spd * 0.5);

    if (player.coffeeBoost > 0) player.coffeeBoost--;

    // Move finish line
    if (finishLine) {
      finishLine.x -= spd;

      // Check if player reached finish line
      if (!finishLine.reached && finishLine.x <= player.x + player.w) {
        finishLine.reached = true;
        finishReached = true;
        celebrationTimer = 150; // frames for celebration
        flashAlpha = 0.6;
        spawnParticles(finishLine.x + 8, groundY - 80, '#a89860', 25);
        spawnParticles(finishLine.x + 8, groundY - 40, '#7a8a7a', 20);
      }
    }

    // Celebration countdown â†’ level transition
    if (finishReached) {
      celebrationTimer--;
      if (celebrationTimer <= 0) {
        if (LEVELS[levelIndex].isFinal) {
          // Won the game!
          state = 'gameover';
          deathReason = 'TENURE ACHIEVED!';
          player.alive = true;
          if (score > hIndex) hIndex = score;
          spawnParticles(player.x + 16, player.y + 22, '#a89860', 40);
        } else {
          // Advance to next level
          levelIndex++;
          levelTimer = 0;
          state = 'playing';
          obstacles = [];
          collectibles = [];
          spawnTimer = 0;
          collectibleTimer = 0;
          initFinishLine();
        }
        return;
      }
      // During celebration: still update particles but don't spawn obstacles
      updateParticles();
      return;
    }

    // Jump
    if ((keys['Space'] || keys['ArrowUp']) && player.grounded) {
      player.vy = -11;
      player.grounded = false;
    }

    // Physics
    player.vy += 0.55;
    player.y += player.vy;
    if (player.y >= groundY - player.h) {
      player.y = groundY - player.h;
      player.vy = 0;
      player.grounded = true;
    }

    // Animation
    player.frameTimer++;
    if (player.frameTimer > 6) {
      player.frame++;
      player.frameTimer = 0;
    }

    // Spawn obstacles (stop when finish line is close)
    const finishNear = finishLine && finishLine.x < W + 200;
    spawnTimer++;
    const spawnRate = Math.max(50, 100 - levelIndex * 10);
    if (!finishNear && spawnTimer > spawnRate + Math.random() * 40) {
      spawnObstacle();
      spawnTimer = 0;
    }

    // Spawn collectibles
    collectibleTimer++;
    if (!finishNear && collectibleTimer > 120 + Math.random() * 80) {
      spawnCollectible();
      collectibleTimer = 0;
    }

    // Move obstacles
    for (let i = obstacles.length - 1; i >= 0; i--) {
      obstacles[i].x -= spd;
      if (obstacles[i].x < -60) obstacles.splice(i, 1);
    }

    // Move collectibles
    for (let i = collectibles.length - 1; i >= 0; i--) {
      collectibles[i].x -= spd;
      if (collectibles[i].x < -40) collectibles.splice(i, 1);
    }

    // Collision detection â€” obstacles
    const px = player.x + 6;
    const py = player.y + 4;
    const pw = player.w - 12;
    const ph = player.h - 8;

    for (const obs of obstacles) {
      if (px < obs.x + obs.w - 4 && px + pw > obs.x + 4 && py < obs.y + obs.h - 4 && py + ph > obs.y + 4) {
        // Hit!
        state = 'gameover';
        player.alive = false;
        deathReason = getDeathReason(obs.type);
        shakeX = 8;
        shakeY = 4;
        if (score > hIndex) hIndex = score;
        spawnParticles(player.x + 16, player.y + 22, PAL.danger, 20);
        break;
      }

      // Score for passing
      if (!obs.scored && obs.x + obs.w < player.x) {
        obs.scored = true;
        score += 50;
      }
    }

    // Collision detection â€” collectibles
    for (let i = collectibles.length - 1; i >= 0; i--) {
      const col = collectibles[i];
      if (px < col.x + col.w && px + pw > col.x && py < col.y + col.h + 10 && py + ph > col.y) {
        if (col.type === 'coffee') {
          player.coffeeBoost = 180; // 3 seconds of boost
          score += 25;
        } else {
          score += 100;
        }
        spawnParticles(col.x + 12, col.y + 10, '#8a7a50', 8);
        collectibles.splice(i, 1);
      }
    }

    // Screen shake decay
    shakeX *= 0.85;
    shakeY *= 0.85;
    if (Math.abs(shakeX) < 0.5) shakeX = 0;
    if (Math.abs(shakeY) < 0.5) shakeY = 0;

    updateParticles();
  }

  // Flash decay (used during celebrations)
  if (flashAlpha > 0.01) {
    flashAlpha *= 0.96;
  }
}

function getDeathReason(type) {
  const reasons = {
    papers: 'BURIED IN UNREAD PAPERS',
    rejection: 'DESK REJECTED!',
    deadline: 'MISSED THE DEADLINE',
    contract: 'CONTRACT EXPIRED',
    movingbox: 'CRUSHED BY RELOCATION',
    randr: 'REVISE & RESUBMIT... AGAIN',
    bureaucracy: 'LOST IN BUREAUCRACY',
    ethics: 'IRB DENIED YOUR STUDY',
    budget: 'BUDGET OVERRUN',
    gdpr: 'GDPR VIOLATION!',
    evaluation: 'DEVASTATING EVAL',
    committee: 'MEETING OVERLOAD',
    service: 'DROWNED IN SERVICE',
    hindexwall: 'h-INDEX TOO LOW',
    restructuring: 'DEPARTMENT RESTRUCTURED',
    adminmeeting: 'ETERNAL MEETING',
    apsrreject: 'APSR DESK REJECTION',
  };
  return reasons[type] || 'PUBLISH OR PERISH';
}

// ---------- DRAW ----------
function draw() {
  ctx.save();
  ctx.translate(Math.floor((Math.random() - 0.5) * shakeX), Math.floor((Math.random() - 0.5) * shakeY));

  if (state === 'title') {
    drawTitleScreen();
  } else if (state === 'playing') {
    drawBackground();
    drawFinishLine();
    collectibles.forEach(drawCollectible);
    obstacles.forEach(drawObstacle);
    drawPixelChar(player.x, player.y);
    drawParticles();
    drawHUD();

    // Celebration overlay when finish line is reached
    if (finishReached && celebrationTimer > 0) {
      drawCelebrationOverlay();
    }
  } else if (state === 'gameover') {
    shakeX = 0;
    shakeY = 0;
    drawBackground();
    collectibles.forEach(drawCollectible);
    obstacles.forEach(drawObstacle);
    drawPixelChar(player.x, player.y);
    drawParticles();
    drawHUD();
    drawGameOverScreen();
  }

  // Flash overlay
  if (flashAlpha > 0.01) {
    ctx.fillStyle = `rgba(200,190,160,${flashAlpha})`;
    ctx.fillRect(0, 0, W, H);
  }

  ctx.restore();
}

function drawTitleScreen() {
  // Background
  const grd = ctx.createLinearGradient(0, 0, 0, H);
  grd.addColorStop(0, '#0e1014');
  grd.addColorStop(1, '#181c18');
  ctx.fillStyle = grd;
  ctx.fillRect(0, 0, W, H);

  // Stars
  stars.forEach(s => {
    const twinkle = Math.sin(frameCount * 0.04 + s.twinkle);
    ctx.fillStyle = `rgba(180,190,170,${0.2 + twinkle * 0.2})`;
    ctx.fillRect(Math.floor(s.x), Math.floor(s.y), Math.ceil(s.size), Math.ceil(s.size));
  });

  // Title
  ctx.fillStyle = PAL.accent;
  ctx.font = '32px "Press Start 2P"';
  ctx.textAlign = 'center';
  ctx.fillText('ARCADE-MIA', W / 2, 140);

  // Subtitle
  ctx.fillStyle = PAL.text;
  ctx.font = '10px "Press Start 2P"';
  ctx.fillText('THE ACADEMIC CAREER RUNNER', W / 2, 175);

  // Character preview
  const prevY = 230;
  drawPixelRect(W / 2 - 16, prevY, 32, 44, '#556677');
  drawPixelRect(W / 2 - 16 + 8, prevY - 16, 20, 16, '#c0a070');
  drawPixelRect(W / 2 - 16 + 4, prevY - 20, 24, 6, '#3a2818');
  drawPixelRect(W / 2 - 16 + 8, prevY - 12, 7, 5, '#222');
  drawPixelRect(W / 2 - 16 + 17, prevY - 12, 7, 5, '#222');

  // Level names preview
  ctx.font = '7px "Press Start 2P"';
  const levelNames = LEVELS.map(l => l.name);
  for (let i = 0; i < levelNames.length; i++) {
    ctx.fillStyle = i === 0 ? PAL.accent : PAL.textDim;
    ctx.fillText(levelNames[i], W / 2, 310 + i * 18);
  }

  // Start prompt
  if (frameCount % 60 < 40) {
    ctx.fillStyle = PAL.white;
    ctx.font = '10px "Press Start 2P"';
    ctx.fillText('PRESS SPACE OR TAP TO START', W / 2, 430);
  }

  // Credit
  ctx.fillStyle = PAL.textDim;
  ctx.font = '6px "Press Start 2P"';
  ctx.fillText('Created by Tim Wappenhans & Claude', W / 2, 470);

  ctx.textAlign = 'left';
}

function drawHUD() {
  const level = LEVELS[levelIndex];

  // Score panel
  ctx.fillStyle = 'rgba(0,0,0,0.6)';
  ctx.fillRect(0, 0, W, 36);
  ctx.fillStyle = PAL.panelBord;
  ctx.fillRect(0, 36, W, 2);

  ctx.fillStyle = PAL.text;
  ctx.font = '9px "Press Start 2P"';
  ctx.textAlign = 'left';
  ctx.fillText('SCORE: ' + score.toString().padStart(7, '0'), 12, 16);

  // h-index
  ctx.fillStyle = PAL.textDim;
  ctx.fillText('h-INDEX: ' + hIndex.toString().padStart(7, '0'), 12, 30);

  // Level name
  ctx.fillStyle = PAL.accent;
  ctx.textAlign = 'right';
  ctx.font = '10px "Press Start 2P"';
  ctx.fillText(level.name.toUpperCase(), W - 12, 16);

  // Level progress bar
  const progressW = 180;
  const progressX = W - progressW - 12;
  const progressFill = Math.min(levelTimer / level.duration, 1);
  ctx.fillStyle = '#222';
  ctx.fillRect(progressX, 24, progressW, 8);
  ctx.fillStyle = level.isFinal ? '#a89860' : '#4a6a4a';
  ctx.fillRect(progressX, 24, progressW * progressFill, 8);
  ctx.strokeStyle = PAL.panelBord;
  ctx.strokeRect(progressX, 24, progressW, 8);

  // Coffee boost indicator
  if (player.coffeeBoost > 0) {
    ctx.fillStyle = '#a89860';
    ctx.textAlign = 'center';
    ctx.font = '7px "Press Start 2P"';
    ctx.fillText('CAFFEINE BOOST', W / 2, 54);
  }

  ctx.textAlign = 'left';
}

function drawCelebrationOverlay() {
  const level = LEVELS[levelIndex];
  const nextLevel = LEVELS[levelIndex + 1];
  const alpha = Math.min(celebrationTimer / 150, 1) * 0.65;
  ctx.fillStyle = `rgba(0,0,0,${alpha})`;
  ctx.fillRect(0, 0, W, H);

  ctx.textAlign = 'center';

  // Title
  ctx.fillStyle = PAL.accent;
  ctx.font = '20px "Press Start 2P"';
  if (level.isFinal) {
    ctx.fillText('TENURE!', W / 2, H / 2 - 30);
  } else {
    ctx.fillText('PROMOTION!', W / 2, H / 2 - 30);
  }

  // Next level name
  if (nextLevel) {
    ctx.fillStyle = PAL.white;
    ctx.font = '11px "Press Start 2P"';
    ctx.fillText('Now: ' + nextLevel.name.toUpperCase(), W / 2, H / 2 + 10);
  }

  // Fun subtitle
  const subs = [
    'Same salary, more stress!',
    'You survived... barely.',
    'Time to update your CV!',
    'More committees await!',
    'The grind continues...',
  ];
  ctx.fillStyle = PAL.textDim;
  ctx.font = '8px "Press Start 2P"';
  ctx.fillText(subs[levelIndex % subs.length], W / 2, H / 2 + 40);

  ctx.textAlign = 'left';
}

function drawGameOverScreen() {
  ctx.fillStyle = 'rgba(0,0,0,0.75)';
  ctx.fillRect(0, 0, W, H);

  ctx.textAlign = 'center';

  if (player.alive) {
    // WON!
    ctx.fillStyle = '#a89860';
    ctx.font = '24px "Press Start 2P"';
    ctx.fillText('ðŸŽ“ TENURE! ðŸŽ“', W / 2, H / 2 - 60);

    ctx.fillStyle = PAL.white;
    ctx.font = '10px "Press Start 2P"';
    ctx.fillText('YOU MADE IT THROUGH ACADEMIA!', W / 2, H / 2 - 20);

    ctx.fillStyle = PAL.text;
    ctx.font = '8px "Press Start 2P"';
    ctx.fillText('FINAL SCORE: ' + score, W / 2, H / 2 + 20);
    ctx.fillText('You now have a nameplate and', W / 2, H / 2 + 50);
    ctx.fillText('an office with a window.', W / 2, H / 2 + 65);

  } else {
    // LOST
    ctx.fillStyle = PAL.danger;
    ctx.font = '18px "Press Start 2P"';
    ctx.fillText('PUBLISH OR PERISH', W / 2, H / 2 - 60);

    ctx.fillStyle = PAL.white;
    ctx.font = '10px "Press Start 2P"';
    ctx.fillText(deathReason, W / 2, H / 2 - 20);

    ctx.fillStyle = PAL.text;
    ctx.font = '8px "Press Start 2P"';
    ctx.fillText('SCORE: ' + score, W / 2, H / 2 + 15);
    ctx.fillText('h-INDEX: ' + hIndex, W / 2, H / 2 + 35);

    ctx.fillStyle = PAL.textDim;
    ctx.font = '7px "Press Start 2P"';
    ctx.fillText('Level: ' + LEVELS[levelIndex].name, W / 2, H / 2 + 60);
  }

  if (frameCount % 60 < 40) {
    ctx.fillStyle = PAL.textDim;
    ctx.font = '8px "Press Start 2P"';
    ctx.fillText('PRESS SPACE OR TAP TO CONTINUE', W / 2, H / 2 + 100);
  }

  ctx.textAlign = 'left';
}

// ---------- GAME LOOP ----------
function gameLoop() {
  update();
  draw();
  requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
</body>
</html>
